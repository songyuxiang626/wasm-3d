<html>
<style>
    html,
    body {
        overflow: hidden;
        height: 100%;
        margin: 0;
    }

    body {
        font-family: Arial, Helvetica, sans-serif;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: black;
        background-repeat: no-repeat;
        background-size: cover;
        background-position: cover;
    }

    #moduleStatusString {
        color: #4AF626;
        text-align: center;
        font-size: 30px;
    }

    #canvas {
        display: none;
        /*border: 1px solid white; Uncomment for layout debug*/
    }
</style>

<head>
    <title>bgfx-glfw-wasm-3dcube-template-starting-point</title>
</head>

<body>
    <canvas id="canvas" style="width: 100%; height: 100%;"></canvas>
    <div id="moduleStatusString">Downloading bgfx-glfw-wasm-3dcube-template-starting-point...</div>
    <script type="text/javascript">
        let canvas = document.getElementById("canvas");
        // make the canvas fullscreen
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        canvas.oncontextmenu = (e) => {
            e.preventDefault();
        }
        let statusElement = document.getElementById('moduleStatusString');
        var downloadingSymbolRightArrow = false;
        var Module = {
            setStatus: function (text) {
                try {
                    // Cool preloader
                    let regexMatch = text.match("([0-9]*)\/([0-9]*)");
                    if (regexMatch != null && regexMatch.length == 3) {
                        let downloaded = parseFloat(regexMatch[1]) / 1024.0 / 1024.0;
                        var total = parseFloat(regexMatch[2]) / 1024.0 / 1024.0;
                        if (total == 0) {
                            total = 1;
                        }
                        let percent = (downloaded / total) * 100;
                        let progress = Math.round(percent).toString() + "%";
                        let downloadingSymbol = downloadingSymbolRightArrow == true ? ">" : "<";
                        downloadingSymbolRightArrow = !downloadingSymbolRightArrow;
                        let outputString = "BGFX Emscripten Resources Downloading...<br>" + downloadingSymbol + " " + downloaded.toFixed(2).toString() + " MB / " + total.toFixed(2).toString() + " MB " + progress;
                        statusElement.innerHTML = outputString;
                        if (percent > 99 && statusElement.style.display != "none") {
                            statusElement.style.display = "none";
                            canvas.style.display = "block";

                            //Module.onWindowResize(canvas.parentElement.clientWidth, canvas.parentElement.clientHeight);

                            const mousedownEvent = (event) => {
                                const rect = canvas?.getBoundingClientRect()

                                if (rect) {
                                    const x = event.clientX - rect.left
                                    const y = event.clientY - rect.top

                                    if (x >= 0 && x <= rect.width && y >= 0 && y <= rect.height) {
                                        const p = {
                                            x: (x / canvas.width) * 2 - 1,
                                            y: -(y / canvas.height) * 2 + 1,
                                        }

                                        Module.addNodeByScreenXY(p.x, p.y, Math.random() * 100);
                                    }
                                }
                            }

                            const mousemoveEvent = (event) => {
                                const rect = canvas?.getBoundingClientRect()

                                if (rect) {
                                    const x = event.clientX - rect.left
                                    const y = event.clientY - rect.top

                                    if (x >= 0 && x <= rect.width && y >= 0 && y <= rect.height) {
                                        const p = {
                                            x: (x / canvas.width) * 2 - 1,
                                            y: -(y / canvas.height) * 2 + 1,
                                        }

                                        Module.intersectNode(p.x, p.y);
                                    }
                                }
                            }

                            const onWindowResize = () => {
                                if (canvas.parentElement) {
                                    Module.onWindowResize(canvas.parentElement.clientWidth, canvas.parentElement.clientHeight);
                                }
                            }

                            window.addEventListener('resize', onWindowResize);
                            canvas.addEventListener('mousedown', mousedownEvent, false)
                            canvas.addEventListener('mousemove', mousemoveEvent, false)
                        }
                    }
                    else {
                        statusElement.innerHTML = "";
                    }
                }
                catch (error) {
                    console.log(error);
                    statusElement.innerHTML = `Error: ${error.toString()}`;
                }
            }
        };
        Module.canvas = canvas;


    </script>
    <script>
        let checkFocus = () => {
            window.focus();
        }
        window.setInterval(checkFocus, 1000);
    </script>
    <script type="text/javascript" src="wasm-3d.js"></script>
</body>

</html>